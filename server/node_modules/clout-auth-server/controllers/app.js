var auth = require('../apis/auth'),
	_ = require('lodash');

module.exports = {
	path: '/',
	method: 'all',
	description: 'Angular Application Loader',
	fn: function (req, res, next) {
		function handleAuthError(err) {
			// redirect with err message
			req.session.err = err;
			res.redirect('/');
		}
		// login
		if (req.method === 'POST') {
			return auth.login.fn(req, _.merge({}, res, {
				success: function (user) {
					// redirect
					res.redirect('/');
				},
				unauthorized: handleAuthError
			}));
		}

		// signout
		if (req.query.signout) {
			return auth.logout.fn(req, _.merge({}, res, {
				success: function (user) {
					// redirect
					res.redirect('/');
				},
				error: handleAuthError
			}));
		}
		var err = req.session.err || null;
		req.session.err && (delete req.session.err);
		res.render('app', {
			user: req.user && req.user.toJson() || null,
			err: err
		});
	}
}