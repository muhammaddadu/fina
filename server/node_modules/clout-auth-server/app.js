/**
 * Clout Auth Server
 */
var clout = require('clout-js'),
	utils = clout.utils,
	path = require('path'),
	debug = require('debug')('clout-auth-server:app'),
	async = require('async'),
	passport = require('passport');

clout.on('started', function () {
	if (clout.server.https) {
		console.info('http server started on port %s', clout.server.https.address().port);
	}
	if (clout.server.http) {
		console.info('http server started on port %s', clout.server.http.address().port);
	}
});

// Append passport to middleware
debug('appending passport to middleware');
(function setupPassport() {
	var STRATEGIES_DIR = path.join(__dirname, 'strategies');
	debug('STRATEGIES_DIR: %s', STRATEGIES_DIR);
	
	utils.getGlobbedFiles(STRATEGIES_DIR + '/**/*.js').forEach(function load(filePath) {
		debug('loading strategy %s', filePath);
		passport.use(require(filePath)());
	});
	debug('passport.initialize');
	clout.app.use(passport.initialize());
	debug('passport.session');
	clout.app.use(passport.session());

	debug('passport.serializeUser');
	passport.serializeUser(clout.models.User.serializeUser());
	debug('passport.deserializeUser');
	passport.deserializeUser(clout.models.User.deserializeUser());
})();

clout.app.use('/bower_components',  clout.express.static(__dirname + '/bower_components'));
debug('using bower_components @/bower_components');

clout.start();
