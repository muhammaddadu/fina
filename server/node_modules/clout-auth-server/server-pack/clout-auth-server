#!/bin/bash
#/etc/init.d/clout-auth-server

SERVICE_NAME='clout-auth-server'
SERVICE_PATH='/fyp/server/node_modules/'$SERVICE_NAME
PID_FILE=$SERVICE_PATH'/PID'

function createDB {
	mysql -uroot -pfyp2016 -e "CREATE DATABASE IF NOT EXISTS \`"$1"\`; GRANT USAGE ON *.* TO root@localhost IDENTIFIED BY 'root'; GRANT ALL PRIVILEGES ON \`"$1"\`.* TO root@localhost; FLUSH PRIVILEGES;"
}


function provision {
	# install services
	echo "Installing dependencing for" $SERVICE_NAME
	cd $SERVICE_PATH && npm install > /dev/null
	echo "Installed!"
	# ensure database available
	createDB "clout-auth-server"
}

function start {
	echo "Starting Service:" $SERVICE_NAME
	if [ -e $PID_FILE ];
	then
		echo "Service Already Running!"
	else
		cd $SERVICE_PATH
		rm -rf log.txt PID
		DEBUG=* nodemon app.js > log.txt 2>&1 &
		echo $! > PID
		echo "Started!"
	fi
}

function stop {
	echo "Stopping Service:" $SERVICE_NAME
	if [ -e $PID_FILE ];
	then
		value=`cat $PID_FILE`
		kill -9 $value
		rm -rf $PID_FILE
		echo "Service Stopped!"
	else
		echo "No Service Found!"
	fi
}

case "$1" in
	start)
		provision
		start
	;;
	stop)
		stop
	;;
	restart)
		stop;
		start;
	;;
	*)
		echo "Usage: /etc/init.d/"$SERVICE_NAME" {start|stop|restart}";
		exit 1;
	;;
esac

exit 0